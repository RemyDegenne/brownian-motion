\chapter{{Filtrations, processes and martingales}}\label{chap:filtration_martingale}


First, recall the definitions of a filtration, an adapted process, a (sub)martingale, a stopping time and a stopped process, which are already in Mathlib.


\begin{definition}[Filtration]\label{def:filtration}
  \mathlibok
  \lean{MeasureTheory.Filtration}
A filtration on a measurable space $(\Omega, \mathcal{A})$ with measure $P$ indexed by a preordered set $T$ is a family of sigma-algebras $\mathcal{F} = (\mathcal{F}_t)_{t \in T}$ such that for all $i \le j$, $\mathcal{F}_i \subseteq \mathcal{F}_j$ and for all $t \in T$, $\mathcal{F}_t \subseteq \mathcal{A}$.
\end{definition}


\begin{definition}\label{def:adapted}
  \uses{def:filtration}
  \mathlibok
  \lean{MeasureTheory.Adapted}
A process $X : T \to \Omega \to E$ is said to be adapted with respect to a filtration $\mathcal{F}$ if for all $t \in T$, $X_t$ is $\mathcal{F}_t$-measurable.
\end{definition}


\begin{definition}[Martingale]\label{def:Martingale}
  \uses{def:adapted}
  \mathlibok
  \lean{MeasureTheory.Martingale}
Let $\mathcal{F}$ be a filtration on a measurable space $\Omega$ with measure $P$ indexed by $T$.
A family of functions $M : T \to \Omega \to E$ is a martingale with respect to a filtration $\mathcal{F}$ if $M$ is adapted with respect to $\mathcal{F}$ and for all $i \le j$, $P[M_j \mid \mathcal{F}_i] = M_i$ almost surely.
\end{definition}


\begin{definition}[Submartingale]\label{def:Submartingale}
  \uses{def:adapted}
  \mathlibok
  \lean{MeasureTheory.Submartingale}
Let $\mathcal{F}$ be a filtration on a measurable space $\Omega$ with measure $P$ indexed by $T$.
A family of functions $M : T \to \Omega \to E$ is a submartingale with respect to a filtration $\mathcal{F}$ if $M$ is adapted with respect to $\mathcal{F}$ and for all $i \le j$, $P[M_j \mid \mathcal{F}_i] \ge M_i$ almost surely.
\end{definition}


\begin{definition}[Stopping time]\label{def:IsStoppingTime}
  \uses{def:filtration}
  \mathlibok
  \lean{MeasureTheory.IsStoppingTime}
A stopping time with respect to some filtration $\mathcal{F}$ indexed by $T$ is a function $\tau : \Omega \to T$ such that for all $i$, the preimage of $\{j \mid j \le i\}$ along $\tau$ is measurable with respect to $\mathcal{F}_i$.
\end{definition}


\begin{definition}[Stopped process]\label{def:stoppedProcess}
  \mathlibok
  \lean{MeasureTheory.stoppedProcess}
Let $X : T \to \Omega \to E$ be a stochastic process and let $\tau : \Omega \to T$.
The stopped process with respect to $\tau$ is defined by
\begin{align*}
  (X^{\tau})_t = \begin{cases}
    X_t & \text{if } t \le \tau \\
    X_{\tau} & \text{otherwise}
  \end{cases}
\end{align*}
\end{definition}


We now give the definition of a filtered probability space satisfying the usual conditions.


\begin{definition}\label{def:leftRightLimitFiltration}
  \uses{def:filtration}
For $\mathcal{F}$ a filtration indexed by $T$ and $t \in T$, we define $\mathcal{F}_{t-} = \bigsqcup_{s < t} \mathcal{F}_s$ (if that supremum is nonempty: we set $\mathcal{F}_{\bot-} = \mathcal{F}_\bot$) and $\mathcal{F}_{t+} = \bigsqcap_{s > t} \mathcal{F}_s$.

Note that $\bigsqcap$ and $\bigsqcup$ denote the infimum and supremum in the lattice of sigma-algebras on $\Omega$.
\end{definition}


\begin{definition}[Right-continuous filtration]\label{def:rightContinuous}
  \uses{def:leftRightLimitFiltration}
We say that the filtration is right-continuous if for all $t \in T$, $\mathcal{F}_t = \mathcal{F}_{t+}$.
\end{definition}


\begin{definition}[Usual conditions]\label{def:usualConditions}
  \uses{def:rightContinuous}
We say that a filtered probability space $(\Omega, \mathcal{F}, P)$ satisfies the usual conditions if the filtration is right-continuous and if $\mathcal{F}_0$ contains all the $P$-null sets.
\end{definition}


\begin{definition}\label{def:predictableMeasurableSpace}
  \uses{def:filtration}
Let $\mathcal{F}$ be a filtration on a measurable space indexed $\Omega$ by a linearly ordered set $T$.
Let $S = \{\{\bot\} \times A \mid A \in \mathcal{F}_\bot\}$ if $T$ has a bottom element and $S = \emptyset$ otherwise.
The predictable sigma-algebra on $T \times \Omega$ is the sigma-algebra generated by the set of sets $\{(t, \infty] \times A \mid t \in T, \: A \in \mathcal{F}_t\} \cup S$.
\end{definition}


\begin{definition}[Predictable process]\label{def:predictable}
  \uses{def:predictableMeasurableSpace}
A process $X : T \to \Omega \to E$ is said to be predictable with respect to a filtration $\mathcal{F}$ if it is measurable with respect to the predictable sigma-algebra on $T \times \Omega$.
\end{definition}


\begin{lemma}\label{lem:Predictable.progressive}
  \uses{def:predictable}
A predictable process is progressively measurable.
\end{lemma}

\begin{proof}

\end{proof}


\begin{lemma}\label{lem:predictable_nat_iff}
  \uses{def:predictable}
Let $X : \mathbb{N} \to \Omega \to E$ be a stochastic process and let $\mathcal{F}$ be a filtration indexed by $\mathbb{N}$.
Then $X$ is predictable if and only if $X_0$ is $\mathcal{F}_0$-measurable and for all $n \in \mathbb{N}$, $X_{n+1}$ is $\mathcal{F}_n$-measurable.
\end{lemma}

\begin{proof}

\end{proof}



\section{Local martingales}


This section contains material taken mostly from \cite[Chapters 10 and 18]{kallenberg2021} and \cite{almostsuremath}.


\begin{definition}[Localizing sequence]\label{def:localizingSequence}
  \uses{def:IsStoppingTime}
A localizing sequence is a sequence of stopping times $(\tau_n)_{n \in \mathbb{N}}$ such that $\tau_n$ is non-decreasing and $\tau_n \to \infty$ as $n \to \infty$ (a.s.).
\end{definition}


\begin{lemma}\label{lem:localizingSequence_min}
  \uses{def:localizingSequence}
Let $(\sigma_n), (\tau_n)$ be localizing sequences.
Then $(\sigma_n \wedge \tau_n)$ is a localizing sequence.
\end{lemma}

\begin{proof}

\end{proof}


\begin{definition}[Local property]\label{def:locally}
  \uses{def:localizingSequence, def:stoppedProcess}
Let $P$ be a class of stochastic processes (or equivalently a predicate on stochastic processes).
We say that a stochastic process $X : \mathbb{R}_+ \to \Omega \to E$ is locally in $P$ (or satisfies $P$ locally) if there exists a localizing sequence $(\tau_n)_{n \in \mathbb{N}}$ such that for all $n \in \mathbb{N}$, the process $X^{\tau_n}\mathbb{I}_{\tau_n > 0}$ is in $P$ (in which $X^{\tau_n}$ denotes the stopped process).
We denote the class of processes that are locally in $P$ by $P_{\mathrm{loc}}$.
\end{definition}


\begin{lemma}\label{lem:implies_locally}
  \uses{def:locally}
For any class of processes $P$, we have $P \subseteq P_{\mathrm{loc}}$.
\end{lemma}

\begin{proof}
Take $\tau_n = \infty$ for all $n$.
\end{proof}


\begin{definition}\label{def:stable}
  \uses{def:locally}
A class of stochastic processes $P$ is stable if whenever $X$ is in $P$, then for any stopping time $\tau$, the process $X^{\tau}\mathbb{I}_{\tau > 0}$ is also in $P$.
\end{definition}


\begin{lemma}\label{lem:locally_inter}
  \uses{def:locally, def:stable}
If $P, Q$ are stable classes of processes then $(P\cap Q)_{\mathrm{loc}} = P_{\mathrm{loc}}\cap Q_{\mathrm{loc}}$.
\end{lemma}

\begin{proof}

\end{proof}


\begin{lemma}\label{lem:locally_mono}
  \uses{def:locally}
If $P \subseteq Q$ then $P_{\mathrm{loc}} \subseteq Q_{\mathrm{loc}}$.
\end{lemma}

\begin{proof}
Let $X \in P_{\mathrm{loc}}$.
Then there exists a localizing sequence $(\tau_n)_{n \in \mathbb{N}}$ such that for all $n \in \mathbb{N}$, $X^{\tau_n}\mathbb{I}_{\tau_n > 0} \in P$.
Since $P \subseteq Q$, for all $n \in \mathbb{N}$, $X^{\tau_n}\mathbb{I}_{\tau_n > 0} \in Q$.
Thus $X \in Q_{\mathrm{loc}}$.
\end{proof}


\begin{lemma}\label{lem:locally_locally}
  \uses{def:locally, def:stable}
For any stable class of processes $P$, we have $(P_{\mathrm{loc}})_{\mathrm{loc}} = P_{\mathrm{loc}}$.
\end{lemma}

\begin{proof}
Let $X$ be a process in $(P_{\mathrm{loc}})_{\mathrm{loc}}$.
By definition there exists a localizing sequence $(\tau_n)_{n \in \mathbb{N}}$ such that for all $n \in \mathbb{N}$, $X^{\tau_n}\mathbb{I}_{\tau_n > 0}$ is in $P_{\mathrm{loc}}$.
By definition of $P_{\mathrm{loc}}$, for each $n$ there exists a localizing sequence $(\sigma_{n,k})_{k \in \mathbb{N}}$ such that for all $k \in \mathbb{N}$, $(X^{\tau_n}\mathbb{I}_{\tau_n > 0})^{\sigma_{n,k}}\mathbb{I}_{\sigma_{n,k} > 0}$ is in $P$.

For each $n$, since $\sigma_{n,k} \to \infty$ a.s. as $k \to \infty$, we may choose $k_n \in \mathbb{N}$ such that $P(\sigma_{n,k_n} < \tau_n \wedge n) \le 2^{-n}$.
Let $\tau'_n = \tau_n \wedge \sigma_{n,k_n}$. $\tau_n' \to \infty$ by the Borel-Cantelli lemma.
Let $\tau''_n = \inf_{m \ge n} \tau'_m$.
Then $(\tau''_n)_{n \in \mathbb{N}}$ is a localizing sequence.

It remains to argue that by stability of $P$, $X^{\tau''_n}\mathbb{I}_{\tau''_n > 0}$ is in $P$ for all $n$.
Indeed, $X^{\tau''_n} = ((X^{\tau_n}\mathbb{I}_{\tau_n > 0})^{\sigma_{n,k_n}}\mathbb{I}_{\sigma_{n,k_n} > 0})^{\tau''_n}\mathbb{I}_{\tau''_n > 0}$. $(X^{\tau_n}\mathbb{I}_{\tau_n > 0})^{\sigma_{n,k_n}}\mathbb{I}_{\sigma_{n,k_n} > 0}$ is in $P$ by construction and $P$ is stable.
\end{proof}


\begin{lemma}[Local implication from global implication]\label{lem:local_induction}
  \uses{def:locally, def:stable}
Let $P, Q$ be two classes of stochastic processes such that $P \subseteq Q_{\mathrm{loc}}$ and $Q$ is stable.
Let $X$ be a stochastic process that satisfies $P$ locally.
Then $X$ satisfies $Q$ locally.
In short, if $P$ implies $Q$ locally, then $P$ locally implies $Q$ locally.
\end{lemma}

\begin{proof}
  \uses{lem:locally_locally, lem:locally_mono}
Since $X \in P_{\mathrm{loc}}$, then $X \in (Q_{\mathrm{loc}})_{\mathrm{loc}}$ by assumption and Lemma~\ref{lem:locally_mono}.
By Lemma \ref{lem:locally_locally}, $(Q_{\mathrm{loc}})_{\mathrm{loc}} = Q_{\mathrm{loc}}$.
Thus $X \in Q_{\mathrm{loc}}$.
\end{proof}


\begin{definition}[Local martingale]\label{def:IsLocalMartingale}
  \uses{def:Martingale, def:locally}
A stochastic process is a local martingale if it is locally a martingale in the sense of Definition~\ref{def:locally}.
That is, there exists a localizing sequence $(\tau_n)_{n \in \mathbb{N}}$ such that for all $n \in \mathbb{N}$, the process $M^{\tau_n}\mathbb{I}_{\tau_n > 0}$ is a martingale.
\end{definition}


\begin{definition}\label{def:IsLocalSubmartingale}
  \uses{def:Submartingale, def:localizingSequence, def:stoppedProcess}
A stochastic process is a local submartingale if it is locally a submartingale in the sense of Definition~\ref{def:locally}.
That is, there exists a localizing sequence $(\tau_n)_{n \in \mathbb{N}}$ such that for all $n \in \mathbb{N}$, the process $M^{\tau_n}\mathbb{I}_{\tau_n > 0}$ is a submartingale.
\end{definition}


\begin{lemma}\label{lem:Martingale.IsLocalMartingale}
  \uses{def:IsLocalMartingale}
Every martingale is a local martingale.
\end{lemma}

\begin{proof}
  \uses{lem:implies_locally}
This follows from Lemma \ref{lem:implies_locally}.
\end{proof}


\begin{lemma}\label{lem:stable_IsMartingale}
  \uses{def:Martingale, def:stable}
The class of martingales is stable. That is, if $M$ is a martingale and $\tau$ is a stopping time, then the stopped process $M^{\tau}\mathbb{I}_{\tau > 0}$ is also a martingale.
\end{lemma}

\begin{proof}
TODO: this should already be in Mathlib? I'm sure we have it for submartingales at least.
\end{proof}


\begin{theorem}\label{thm:IsLocalMartingale.eq_zero_of_finiteVariation}
  \uses{def:IsLocalMartingale}
Let $M$ be a continuous local martingale with $M_0 = 0$. If $M$ is also a finite variation process, then $M_t = 0$ for all $t$.
\end{theorem}

\begin{proof}

\end{proof}
